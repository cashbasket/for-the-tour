<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-scope" content="profile email https://www.googleapis.com/auth/calendar">
    <meta name="google-signin-client_id" content="725149234874-5pcbriu0k6nsqe1mglf4oonqcel1ibpn.apps.googleusercontent.com">
    <title>For the Tour</title>
    <script defer src="https://use.fontawesome.com/releases/v5.0.1/js/all.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6B8Nejb7hMHFIcxtizjTPMLXPVWCxaXY&callback=initMap"
        async defer></script>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://cdn.quilljs.com/1.3.4/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.4/quill.bubble.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/reset.css">
	<link rel="stylesheet" href="assets/css/styles.css">
    <link href="https://fonts.googleapis.com/css?family=Bungee|Lobster|Permanent+Marker" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans+Condensed:400,600,700|Roboto:400,400i,700,700i" rel="stylesheet">
</head>
<body class="site">
    <header>
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="row">
                <div class="container">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-items" aria-expanded="false">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="navbar-button-text">Menu</span>
                            </button>
                            <h1 id="homepage" class="navbar-brand hidden"><a href=".">For the Tour</a></h1>
                        </div>
                        <div class="collapse navbar-collapse" id="nav-items">
                            <ul class="nav navbar-nav hidden" id="loginRSVPs">
                                <li><a href="view-rsvps.html">My RSVPs</a></li>
                            </ul>
                             <div class="navbar-text navbar-right">
                                <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
                                <div class="user-info"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <div class="container site-content">
        <div id="homeSearch" class="home-search">
            <img src="assets/images/vanimage.png" alt="Image of a van" class="main-image img-responsive" />
            <h1>FOR THE TOUR</h1>
            <p>Know your show.</p>
            <div class="row">
                <div class="col-md-6 col-md-push-3">
                    <form class ="searchForm" action="search.html">
                        <div class="form-group">
                            <input type="text" name="b" id="bandName" placeholder="Enter a band name..." class="form-control search-input" required pattern="^(.*?)([A-Za-z0-9!-+&@']+)$"/>
                        </div>
                        <button type="submit" class="btn-home">Search</button>
                    </form>
              </div>
            </div>
        </div>
    </div>

    <footer>
        <a href="https://songkick.com" target="_blank"><img src="assets/images/powered-by-songkick-white.png" class="footer-image"></a>
    </footer>
    <script src="https://cdn.quilljs.com/1.3.4/quill.js"></script>
    <script src="https://cdn.quilljs.com/1.3.4/quill.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
        var CLIENT_ID = '725149234874-5pcbriu0k6nsqe1mglf4oonqcel1ibpn';
        var API_KEY = 'AIzaSyA6B8Nejb7hMHFIcxtizjTPMLXPVWCxaXY';
        var SCOPES = "https://www.googleapis.com/auth/calendar profile email";
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        var firebaseConfig = {
            apiKey: 'AIzaSyDs9iz9p-7I_mGuLqHUlhnz-sSQyqwgE_c',
            authDomain: 'for-the-tour.firebaseapp.com',
            databaseURL: 'https://for-the-tour.firebaseio.com',
            projectId: 'for-the-tour',
            storageBucket: 'for-the-tour.appspot.com',
            messagingSenderId: '725149234874'
        };
        firebase.initializeApp(firebaseConfig);

        var isLoggedIn = false;    
        function onSignIn(googleUser) {
            // We need to register an Observer on Firebase Auth to make sure auth is initialized.
            var unsubscribe = firebase.auth().onAuthStateChanged(function(firebaseUser) {
                unsubscribe();
                // Check if we are already signed-in Firebase with the correct user.
                if (!isUserEqual(googleUser, firebaseUser)) {
                    // Build Firebase credential with the Google ID token.
                    var credential = firebase.auth.GoogleAuthProvider.credential(
                        googleUser.getAuthResponse().id_token);
                    // Sign in with credential from the Google user.
                    firebase.auth().signInWithCredential(credential).catch(function(error) {
                        // Handle Errors here.
                        var errorCode = error.code;
                        var errorMessage = error.message;
                        // The email of the user's account used.
                        var email = error.email;
                        // The firebase.auth.AuthCredential type that was used.
                        var credential = error.credential;
                        // ...
                    });
                }
            });
            var profile = googleUser.getBasicProfile();
            var email = profile.getEmail();
            var photo = profile.getImageUrl();
            // The ID token you need to pass to your backend:
            var id_token = googleUser.getAuthResponse().id_token;
            isLoggedIn = true;

            if (isLoggedIn) {
                $('.user-info').html( email + '</strong> (<a class="sign-out">Sign Out</a>)');
                $('.g-signin2').hide();
                $('.user-info').removeClass('hidden');
                $('#loginRSVPs').removeClass('hidden');
            }
        }
        function isUserEqual(googleUser, firebaseUser) {
            if (firebaseUser) {
                var providerData = firebaseUser.providerData;
                for (var i = 0; i < providerData.length; i++) {
                    if (providerData[i].providerId === firebase.auth.GoogleAuthProvider.PROVIDER_ID &&
                        providerData[i].uid === googleUser.getBasicProfile().getId()) {
                        // We don't need to reauth the Firebase connection.
                        return true;
                    }
                }
            }
            return false;
        }

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            });
        }
        
        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                firebase.auth().signOut();
                // disable RSVPs
                $('#loginRSVPs').addClass('hidden');
                isLoggedIn = false;
                // hide user info and show sign-in button
                $('.g-signin2').show();
            });
        }
        $(document).ready(function() {            
            $('body').on('click', '.sign-out', function() {
                signOut();
            });
        });

    </script>
    <script src="assets/javascript/app.js"></script>
    <script async defer src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
</body>
</html>